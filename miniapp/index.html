<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B2B Mini App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    function App() {
      const [user, setUser] = React.useState(null);
      const [products, setProducts] = React.useState([]);
      const [formData, setFormData] = React.useState({ productId: '', quantity: '' });
      const [isRegistered, setIsRegistered] = React.useState(false);
      const API_URL = 'https://b2b-tg-bot-5ru8.vercel.app'; // URL твоего API

      // Режим разработчика: фиктивный пользователь для тестирования вне Telegram
      const isDevMode = new URLSearchParams(window.location.search).get('dev') === 'true';
      const devUser = {
        id: 123456789,
        first_name: 'Тестовый Пользователь',
      };

      // Инициализация Telegram Web App
      React.useEffect(() => {
        console.log('Проверяем Telegram WebApp...');
        console.log('window.Telegram:', window.Telegram);
        console.log('window.Telegram.WebApp:', window.Telegram?.WebApp);

        if (isDevMode) {
          console.log('Запущен режим разработчика');
          setUser(devUser);
          fetchProducts();
          checkRegistration(devUser.id);
        } else if (window.Telegram && window.Telegram.WebApp) {
          console.log('Telegram WebApp найден, инициализируем...');
          window.Telegram.WebApp.ready();
          const telegramUser = window.Telegram.WebApp.initDataUnsafe.user;
          console.log('Пользователь из Telegram:', telegramUser);
          console.log('initData:', window.Telegram.WebApp.initData);
          setUser(telegramUser);
          fetchProducts();
          if (telegramUser?.id) {
            checkRegistration(telegramUser.id);
          } else {
            console.error('ID пользователя отсутствует');
          }
        } else {
          console.error('Telegram WebApp не найден');
        }
      }, []);

      const fetchProducts = () => {
        fetch(`${API_URL}/api/products`)
          .then((res) => {
            console.log('Статус ответа от API/products:', res.status);
            return res.json();
          })
          .then((data) => {
            console.log('Продукты:', data);
            setProducts(data);
          })
          .catch((err) => console.error('Ошибка загрузки продуктов:', err));
      };

      const checkRegistration = (telegramId) => {
        fetch(`${API_URL}/api/registrations?telegramId=${telegramId}`)
          .then((res) => {
            console.log('Статус ответа от API/registrations:', res.status);
            return res.json();
          })
          .then((data) => {
            console.log('Данные регистрации:', data);
            if (data.status === 'approved') setIsRegistered(true);
          })
          .catch((err) => console.error('Ошибка проверки регистрации:', err));
      };

      // Если пользователь не авторизован и не в режиме разработчика
      if (!user && !isDevMode) {
        return <div className="p-4">Пожалуйста, откройте приложение в Telegram.</div>;
      }

      // Если пользователь не зарегистрирован
      if (!isRegistered) {
        const handleRegister = () => {
          fetch(`${API_URL}/api/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              telegramId: user?.id,
              name: user?.first_name,
              initData: isDevMode ? 'dev_mode' : window.Telegram?.WebApp?.initData,
            }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                alert('Регистрация отправлена на подтверждение!');
              } else {
                alert('Ошибка при регистрации: ' + (data.error || 'Неизвестная ошибка'));
              }
            })
            .catch((err) => console.error('Ошибка регистрации:', err));
        };

        return (
          <div className="p-4 max-w-md mx-auto">
            <h1 className="text-2xl font-bold mb-4">Регистрация B2B</h1>
            <p>Добро пожаловать, {user?.first_name || 'Пользователь'}!</p>
            <button
              onClick={handleRegister}
              className="mt-4 bg-blue-500 text-white px-4 py-2 rounded"
            >
              Зарегистрироваться
            </button>
            {isDevMode && (
              <p className="mt-2 text-red-500">Режим разработчика: данные фиктивные</p>
            )}
          </div>
        );
      }

      // Основной интерфейс для зарегистрированных пользователей
      const handleOrderSubmit = (e) => {
        e.preventDefault();
        fetch(`${API_URL}/api/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...formData,
            telegramId: user?.id,
            initData: isDevMode ? 'dev_mode' : window.Telegram?.WebApp?.initData,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              alert('Заявка успешно создана!');
              setFormData({ productId: '', quantity: '' });
            } else {
              alert(data.error || 'Ошибка при создании заявки');
            }
          })
          .catch((err) => console.error('Ошибка отправки заявки:', err));
      };

      return (
        <div className="p-4 max-w-md mx-auto">
          <h1 className="text-2xl font-bold mb-4">B2B Заявки</h1>
          <h2 className="text-lg mb-2">Продукты</h2>
          <ul className="mb-4">
            {products.map((product) => (
              <li key={product.id} className="mb-2">
                {product.name} (В наличии: {product.stock})
              </li>
            ))}
          </ul>
          <h2 className="text-lg mb-2">Создать заявку</h2>
          <form onSubmit={handleOrderSubmit}>
            <select
              value={formData.productId}
              onChange={(e) => setFormData({ ...formData, productId: e.target.value })}
              className="w-full p-2 mb-2 border rounded"
            >
              <option value="">Выберите продукт</option>
              {products.map((product) => (
                <option key={product.id} value={product.id}>
                  {product.name}
                </option>
              ))}
            </select>
            <input
              type="number"
              value={formData.quantity}
              onChange={(e) => setFormData({ ...formData, quantity: e.target.value })}
              placeholder="Количество"
              className="w-full p-2 mb-2 border rounded"
            />
            <button type="submit" className="bg-blue-500 text-white px-4 py-2 rounded">
              Отправить заявку
            </button>
          </form>
          {isDevMode && (
            <p className="mt-2 text-red-500">Режим разработчика: данные фиктивные</p>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>